<script type="text/javascript">

  function submitForm(ticketId) {
    $("#threadForm_" + ticketId).submit();
  }

  function onBtnClick(ticketId) {
    submitForm(ticketId);
  }

</script>

<div class="clearfix">
  <div class="btn-group pull-left">
    <a href="/ticket/tickets" class="btn btn-default active">我的工单</a>
    <a href="/ticket/history" class="btn btn-default">我的任务</a>
    <a href="/ticket/stocks" class="btn btn-default">已完成</a>
  </div>
  <a class="btn btn-primary" href="/tickets/new" style="margin-left: 10px;">新建工单</a>
</div>

<div id="collapseTwo" class="panel-collapse clearfix">
    <div class="panel-body">
        <form id="searchForm" class="thread-form" enctype="multipart/form-data"
          action="/ticket/tickets/search" method="post">
            <div class="form-group">
                <select id="inputType" class="form-control" name="type" >
                  <option value="" selected="selected">请选择-流程</option>
                  <option value="consult">咨询流程</option>
                  <option value="new">新品处理流程</option>
                  <option value="cancelOrders">退换货处理流程</option>
                  <option value="complain">投诉流程</option>
                  <option value="check">订单查重流程</option>
                  <option value="noCar">未分车订单处理流程</option>
                  <option value="visit">订单评价回访流程</option>
                  <option value="firstVisit">首单回访流程</option>
                </select>
            </div>
            <div class="form-group">
                <select id="sourceType" class="form-control" name="sourceType" >
                  <option value="" selected="selected">请选择-来源</option>
                  <option value="wxcrowd">微信群</option>
                  <option value="wechat">微信平台</option>
                  <option value="tel400">400电话</option>
                  <option value="cgwyapp">App</option>
                  <option value="other">其他</option>
                </select>
            </div>
            <div class="form-group">
                <select id="stateType" class="form-control" name="stateType" >
                  <option selected="selected">请选择-状态</option>
                  <option value="0">等待处理</option>
                  <option value="3">待分配</option>
                  <option value="1">已回复</option>
                  <option value="2">完成</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="startTime" name="startTime" class="form-control" placeholder="起始时间" />
            </div>
            <div class="form-group">
                <input type="text" id="endTime" name="endTime" class="form-control" placeholder="结束时间" />
            </div>
            <div class="form-group">
                <input type="text" name='restaurantID' class="form-control" placeholder="餐馆ID"/>
            </div>
            <div class="form-group">
                <input type="text" name='restaurantName' class="form-control" placeholder="餐馆名称" >
            </div>
            <div class="form-group">
                <input type="text" name='orderId' class="form-control" placeholder="订单ID" >
            </div>
            <div class="form-group">
                <input type="text" name='consultUser' class="form-control" placeholder="咨询人" >
            </div>
            <div class="form-group">
                <input type="text" name='consultTel' class="form-control" placeholder="咨询人手机号" >
            </div>
            <div class="form-group">
                <select id="followUser" name="followUser" data-placeholder="待跟进人" style="width: 350px; display: none;" class="form-control chosen-select-deselect" tabindex="-1">
                  <option value=""></option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary btn-submit" >&nbsp;&nbsp;搜&nbsp;&nbsp;索&nbsp;&nbsp;</button>
        </form>
    </div>
</div>
<hr>

<div>
  <table class="table table-borderless table-sortable">
    <thead>
    <tr>
      <th data-sort="int">工单ID</th>
      <th data-sort="string">类型</th>
      <th data-sort="string">咨询人</th>
      <th data-sort="string">咨询人手机</th>
      <th data-sort="string">关联餐馆ID</th>
      <th data-sort="string">餐馆名称</th>
      <th data-sort="string">餐馆电话</th>
      <th data-sort="string">关联订单ID</th>
      <th data-sort="string">状态</th>
      <th data-sort="string">来源</th>
      <th data-sort="string">待跟进人</th>
      <th data-sort="string">待跟进人手机</th>
      <th data-sort="int" data-sort-default="desc" data-sort-onload>创建时间</th>
    </tr>
    </thead>
    <tbody>
    <% tickets.forEach (function (ticket){ %>
      <% if(ticket.username == mClient.username){ %>
        <tr>
          <td class="table-type" data-sort-value="<%=ticket.ticket_id%>">#<%= ticket.ticket_id%></td>
          <td class="table-type"><a href="/ticket/tickets/<%=ticket.id%>/threads" title="#<%= ticket.ticket_id %>"><%= ticket.type %></a></td>
          <td class="table-type"><%= ticket.consultUser %></td>
          <td class="table-type"><%= ticket.consultTel %></td>
          <td class="table-type"><%= ticket.restaurantID %></td>
          <td class="table-type"><%= ticket.restaurantName %></td>
          <td class="table-type"><%= ticket.restaurantTel %></td>
          <td class="table-type"><%= ticket.orderId %></td>
          <% if(ticket.followUser != '' && ticket.status !="待分配" || ticket.status == "完成" ){ %>
          <td class="table-type"><%= ticket.status %></td>
          <% } else{ %>
          <td class="table-type">待分配</td>
          <% } %>
          <td class="table-type"><%= ticket.stype %></td>
          <td class="table-type"><%= ticket.followUser %></td>
          <td class="table-type"><%= ticket.followTel %></td>
          <td class="table-date"><%= ticket.createdAtLong %></td>
        </tr>
      <% } %>
    <% }) %>
    </tbody>
  </table>
  
</div>
<script>
  $( "#startTime" ).datepicker({
    defaultDate: "",
    changeMonth: true,
    numberOfMonths: 1,
    onClose: function( selectedDate ) {
      $( "#endTime" ).datepicker( "option", "minDate", selectedDate );
    }
  });
  
  $( "#endTime" ).datepicker({
    defaultDate: "",
    changeMonth: true,
    numberOfMonths: 1,
    onClose: function( selectedDate ) {
      $( "#startTime" ).datepicker( "option", "maxDate", selectedDate );
    }
  });
  $.ajax({ 
      url: "http://www.canguanwuyou.cn/admin/api/admin-user?pageSize=10000", 
      type: "GET",
      dataType: "json",
      success: function(data){
          //console.log(data.adminUsers[0].realname);
          var str = $('#followUser').html();
          for(var i=0; i<data.adminUsers.length;i++){
              str += "<option>"+data.adminUsers[i].realname+"</option>";
          }
          $('#followUser').html(str);
          var config = {
              '.chosen-select'           : {},
              '.chosen-select-deselect'  : {allow_single_deselect:true},
              '.chosen-select-no-single' : {disable_search_threshold:1},
              '.chosen-select-no-results': {no_results_text:'Oops, nothing found!'},
              '.chosen-select-width'     : {width:"95%"}
            }
          $(".chosen-select-deselect").chosen({width: "100%"});
          $(".chosen-select-deselect").chosen({height: "100px"});
          for (var selector in config) {
            $(selector).chosen(config[selector]);
          }
      }
    });
</script>